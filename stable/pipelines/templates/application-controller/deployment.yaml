{{- if .Values.deployment.create }}
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  labels:
    component: application-controller
    control-plane: controller-manager
    controller-tools.k8s.io: "1.0"
{{ include "pipelines.commonLabels" . | indent 4 }}
  name: controller-manager
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      component: application-controller
      control-plane: controller-manager
      controller-tools.k8s.io: "1.0"
{{ include "pipelines.commonLabels" . | indent 6 }}
  template:
    metadata:
      labels:
        component: application-controller
        control-plane: controller-manager
        controller-tools.k8s.io: "1.0"
{{ include "pipelines.commonLabels" . | indent 8 }}
    spec:
      containers:
      - name: manager
        image: {{ .Values.images.application-controller.repository }}:{{ .Values.images.application-controller.tag }}
        imagePullPolicy: {{ .Values.images.imagePullPolicy }}
        command:
          - /root/manager
        env:
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
      resources:
{{ toYaml .Values.resources | indent 8 }}
      serviceAccountName: pipelines-application
{{- end }}
